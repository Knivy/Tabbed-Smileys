<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">

<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">

	<id>emanuele:tabbed_smileys</id>
	<version>0.3.99</version>

	<file name="$sourcedir/Load.php">
		<operation><!-- 1 -->
			<search position="after"><![CDATA[
	// Integration is cool.]]></search>
			<add><![CDATA[
	if(isset($modSettings['tabbed_smileys']) && !is_array($modSettings['tabbed_smileys'])){
		$modSettings['tabbed_smileys'] = unserialize($modSettings['tabbed_smileys']);
	}
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/ManageSmileys.php">
		<operation><!-- 1 -->
			<search position="before"><![CDATA[
			'smiley_enable' => isset($_POST['smiley_enable']) ? '1' : '0',]]></search>
			<add><![CDATA[
			'hide_more_smiley' => isset($_POST['hide_more_smiley']) ? '1' : '0',
]]></add>
		</operation>
		<operation><!-- 2 -->
			<search position="replace"><![CDATA[
				if (isset($displayTypes[$_POST['smiley_action']]))
					db_query("
						UPDATE {$db_prefix}smileys
						SET hidden = " . $displayTypes[$_POST['smiley_action']] . "
						WHERE ID_SMILEY IN (" . implode(', ', $_POST['checked_smileys']) . ')', __FILE__, __LINE__);
			}
]]></search>
			<add><![CDATA[
				if (isset($displayTypes[$_POST['smiley_action']])){
					db_query("
						UPDATE {$db_prefix}smileys
						SET hidden = " . $displayTypes[$_POST['smiley_action']] . "
						WHERE ID_SMILEY IN (" . implode(', ', $_POST['checked_smileys']) . ')', __FILE__, __LINE__);
				} elseif(strpos($_POST['smiley_action'], 'addtab_')!==false) {
					$id = explode('_', $_POST['smiley_action']);
					db_query("
						UPDATE {$db_prefix}smileys
						SET hidden = " . ($id[1]==0 ? 0 : 2) . "
						WHERE ID_SMILEY IN (" . implode(', ', $_POST['checked_smileys']) . ')', __FILE__, __LINE__);
					db_query("
						UPDATE {$db_prefix}smileys
						SET smileyRow = " . ($id[1]==0 ? 0 : ($id[1]-1)) . "
						WHERE ID_SMILEY IN (" . implode(', ', $_POST['checked_smileys']) . ')', __FILE__, __LINE__);
				}
			}
]]></add>
		</operation>
		<operation><!-- 3 -->
			<search position="before"><![CDATA[
function EditSmileyOrder()
{
	global $modSettings, $context, $settings, $db_prefix, $txt, $boarddir;
]]></search>
			<add><![CDATA[
	//A form was submitted
	if (isset($_POST['sc']))
	{
		checkSession();

		$locations[] = 'postform';
		$locations[] = 'popup';

		foreach($locations as $location){
			if(isset($_POST[$location])){
				if(is_array($_POST[$location])){
					$temp[$location]=array();
					foreach($_POST[$location] as $id => $value){
						$temp[$location][$id] = str_replace('\\', '&#92;', htmlentities(strip_tags(stripslashes($value)), ENT_QUOTES));
					}
				} else {
					$temp[$location] = str_replace('\\', '&#92;', htmlentities(strip_tags(stripslashes($_POST[$location])), ENT_QUOTES));
				}
			}
		}
		updateSettings(array('tabbed_smileys' => serialize($temp)));
		updateSettings(array('tabbed_smilyes_style' => htmlspecialchars(strip_tags($_POST['style_edit']), ENT_QUOTES)));
		$modSettings['tabbed_smileys'] = unserialize($modSettings['tabbed_smileys']);
		unset($temp);
	}

]]></add>
		</operation>

	</file>

	<file name="$sourcedir/Subs.php">
		<operation><!-- 1 -->
			<search position="before"><![CDATA[
	// This is done to make it easier to add to all themes...
]]></search>
			<add><![CDATA[
	if (!empty($modSettings['smiley_enable'])){
		$context['html_headers'] .= '
	<style type="text/css">
		' . (!empty($modSettings['tabbed_smilyes_style']) ? $modSettings['tabbed_smilyes_style'] : 'ul#tabs {
			overflow:auto;
			list-style-type: none;
			margin: 30px 0 0 0;
			padding: 1px 0 0 0;
		}
		ul#tabs li {
			float:left;
			margin:0.3em 0.2em;
		}
		ul#tabs li a {
			color: #000;
			border: 1px solid #ADADAD;
			border-bottom: none;
			padding: 0.3em;
			text-decoration: none;
		}
		div.tabContent {
			border: 1px solid #ADADAD;
			width:95%;
		}
		div.hide {
			display: none;
		}') . '
	</style>';
	}
]]></add>
		</operation>
	</file>

	<file name="$themedir/Post.template.php">
		<operation><!-- 1 -->
			<search position="replace"><![CDATA[	// Now start printing all of the smileys.
	if (!empty($context['smileys']['postform']))
	{
		echo '
			<tr>
				<td align="right"></td>
				<td valign="middle">';

		// Show each row of smileys ;).
		foreach ($context['smileys']['postform'] as $smiley_row)
		{
			foreach ($smiley_row['smileys'] as $smiley)
				echo '
					<a href="javascript:void(0);" onclick="replaceText(\' ', $smiley['code'], '\', document.forms.', $context['post_form'], '.', $context['post_box_name'], '); return false;"><img src="', $settings['smileys_url'], '/', $smiley['filename'], '" align="bottom" alt="', $smiley['description'], '" title="', $smiley['description'], '" /></a>';

			// If this isn't the last row, show a break.
			if (empty($smiley_row['last']))
				echo '<br />';
		}

		// If the smileys popup is to be shown... show it!
		if (!empty($context['smileys']['popup']))
]]></search>
			<add><![CDATA[	// Now start printing all of the smileys.
	if (!empty($context['smileys']['postform']))
	{
		if (!empty($modSettings['smiley_enable'])){
			echo '
			<tr>
				<td align="right"></td>
				<td valign="middle">';
			echo '
					<ul id="tabs">';
			$current_name = !empty($modSettings['tabbed_smileys']['postform']) ? $modSettings['tabbed_smileys']['postform'] : $txt['basic_smileys'];
			echo '
						<li><a class="titlebg selected" onclick="toggleElem(this.id); return false;" id="tab_0" href="javascript:{}">' . $current_name . '</a></li>';
			if (!empty($context['smileys']['popup'])){
				$i=0;
				foreach ($context['smileys']['popup'] as $smiley_row){
					$i++;
					$current_name = !empty($modSettings['tabbed_smileys']['popup'][$i]) ? $modSettings['tabbed_smileys']['popup'][$i] : $txt['additional_smileys'] . ' '. $i;
					echo '
							<li><a class="catbg unselected" onclick="toggleElem(this.id); return false;" id="tab_' . $i . '" href="javascript:{}">' . $current_name . '</a></li>';
				}
			}
			echo '
					</ul>';

			echo '
					<div class="tabContent windowbg2" id="tab_smiley_content"></div>';

			echo '

					<script language="JavaScript" type="text/javascript"><!-- // --><![' . 'CDATA[
						var tabs_content = Array();
						function toggleElem(elem) {
							var tabsIndex = document.getElementById(\'tabs\');
							var tabsElements = tabsIndex.getElementsByTagName(\'li\').length;
							var tid = elem.split(\'_\');

							for (var i=0; i<tabsElements; i++) {
								if(elem == \'tab_\'+i){
									document.getElementById(\'tab_\'+i).className = \'titlebg selected\';
								} else {
									document.getElementById(\'tab_\'+i).className = \'catbg unselected\';
								}
							}
							var smiley_content = document.getElementById(\'tab_smiley_content\');
							smiley_content.innerHTML = tabs_content[tid[1]];
						}

						tabs_content[0] = \'';

			// Show each row of smileys ;).
			foreach ($context['smileys']['postform'] as $smiley_row){
				foreach ($smiley_row['smileys'] as $smiley)
					echo addslashes(' <a href="javascript:void(0);" onclick="replaceText(\' ' . $smiley['code'] . '\', document.forms.' . $context['post_form'] . '.' . $context['post_box_name'] . '); return false;"><img src="' . $settings['smileys_url'] . '/' . $smiley['filename'] . '" align="bottom" alt="' . $smiley['description'] . '" title="' . $smiley['description'] . '" /></a>');

				// If this isn't the last row, show a break.
				if (empty($smiley_row['last']))
					echo addslashes('<br />');
			}

			echo '\';';

			$i=0;
			if (!empty($context['smileys']['popup'])){
				foreach ($context['smileys']['popup'] as $smiley_row){
					$i++;
					echo '
						tabs_content[' . $i . '] = \'';

					foreach ($smiley_row['smileys'] as $smiley)
						echo addslashes(' <a href="javascript:void(0);" onclick="replaceText(\' ' . $smiley['code'] . '\', document.forms.' . $context['post_form'] . '.' . $context['post_box_name'] . '); return false;"><img src="' . $settings['smileys_url'] . '/' . $smiley['filename'] . '" align="bottom" alt="' . $smiley['description'] . '" title="' . $smiley['description'] . '" /></a>');

					echo '\';';
				}
			}
			echo '
			toggleElem(\'tab_0\');
// ]' . ']></script>';

		} else {
			echo '
			<tr>
				<td align="right"></td>
				<td valign="middle">';

		// Show each row of smileys ;).
			foreach ($context['smileys']['postform'] as $smiley_row)
			{
				foreach ($smiley_row['smileys'] as $smiley)
					echo '
					<a href="javascript:void(0);" onclick="replaceText(\' ', $smiley['code'], '\', document.forms.', $context['post_form'], '.', $context['post_box_name'], '); return false;"><img src="', $settings['smileys_url'], '/', $smiley['filename'], '" align="bottom" alt="', $smiley['description'], '" title="', $smiley['description'], '" /></a>';

				// If this isn't the last row, show a break.
				if (empty($smiley_row['last']))
					echo '<br />';
			}
		}

		// If the smileys popup is to be shown... show it!
		if (!empty($context['smileys']['popup']) && empty($modSettings['hide_more_smiley']))
]]></add>
		</operation>
	</file>

	<file name="$themedir/ManageSmileys.template.php">
		<operation><!-- 1 -->
			<search position="before"><![CDATA[
				<td><input type="checkbox" name="smiley_enable" id="smiley_enable"', empty($modSettings['smiley_enable']) ? '' : ' checked="checked"', ' class="check" /></td>]]></search>
			<add><![CDATA[';
		if(!empty($modSettings['smiley_enable']))
			echo '
			</tr><tr class="windowbg2">
				<td align="right"><label for="hide_more_smiley">', $txt['hide_more_smiley'], '</label>:</td>
				<td><input type="checkbox" name="hide_more_smiley" id="hide_more_smiley"', empty($modSettings['hide_more_smiley']) ? '' : ' checked="checked"', ' class="check" /></td>';

		echo '
]]></add>
		</operation>
		<operation><!-- 2 -->
			<search position="replace"><![CDATA[
					', $smiley['location'], ']]></search>
			<add><![CDATA[
					', $smiley['location'], ($smiley['location']=='Popup' ? (' (' . $txt['tabbed_smileys_tab'] . ': ' . (!empty($modSettings['tabbed_smileys']['popup'][$smiley['row']+1]) ? $modSettings['tabbed_smileys']['popup'][$smiley['row']+1] : $txt['additional_smileys'] . ' ' . ($smiley['row']+1)) . ')') : '') . ']]></add>
		</operation>
		<operation><!-- 3 -->
			<search position="replace"><![CDATA[
						<option value="delete">', $txt['smileys_remove'], '</option>
					</select>
]]></search>
			<add><![CDATA[
						<option value="delete">', $txt['smileys_remove'], '</option>
						<option value="-1">--------------</option>
						<option value="addtab_0">', !empty($modSettings['tabbed_smileys']['postform']) ? $modSettings['tabbed_smileys']['postform'] : $txt['basic_smileys'], '</option>';
		$rows = 0;
		foreach($context['smileys'] as $smiley){
			if($rows<$smiley['row'])
				$rows=$smiley['row'];
		}
		$rows++;
		for($i=1;$i<=$rows;$i++){
			echo '
							<option value="addtab_', $i, '">', !empty($modSettings['tabbed_smileys']['popup'][$i]) ? $modSettings['tabbed_smileys']['popup'][$i] : ($txt['additional_smileys'] . ' '. $i), '</option>';
		}
		echo '
					</select>
]]></add>
		</operation>
		<operation><!-- 4 -->
			<search position="after"><![CDATA[}

// Editing Message Icons
function template_editicons()
{]]></search>
			<add><![CDATA[

// Here for naming tabs
	echo '
	<br />
	<form action="', $scripturl, '?action=smileys;sa=setorder" method="post" accept-charset="', $context['character_set'], '">
		<table border="0" cellspacing="1" cellpadding="4" align="center" width="80%" class="tborder" style="padding: 1px;">
			<tr class="titlebg">
				<td colspan="2">', $txt['tabbed_smileys_tabsnames'], '</td>
			</tr>
			<tr class="windowbg">
				<td colspan="2" class="smalltext">', $txt['tabbed_smileys_tabsnames_description'], '</td>
			</tr>';
	foreach ($context['smileys'] as $name => $location)
	{
		if($name!='postform'){
			foreach ($location['rows'] as $id => $row)
			{
				$current_name = isset($modSettings['tabbed_smileys'][$name][$id+1]) ? $modSettings['tabbed_smileys'][$name][$id+1] : $txt['additional_smileys'] . ' '. ($id+1);
				echo '
			<tr class="windowbg2">
				<td>', $location['title'], ' - ', $txt['tabbed_smileys_row'], ($id + 1), '</td><td><input type="text" name="', $name, '[', ($id + 1), ']" value="', $current_name, '"/></td>
			</tr>';
			}
		} else {
			$current_name = isset($modSettings['tabbed_smileys'][$name]) ? $modSettings['tabbed_smileys'][$name] : $txt['basic_smileys'];
			echo '
			<tr class="windowbg2">
				<td>', $location['title'], '</td><td><input type="text" name="', $name, '" value="', $current_name, '"/></td>
			</tr>';
		}
	}
	echo '
			<tr class="windowbg2"><td colspan="2"></td></tr>
			<tr class="titlebg">
				<td colspan="2">', $txt['tabbed_smileys_style'], '</td>
			</tr>
			<tr class="windowbg2">
				<td colspan="2">
					<textarea id="style_edit" name="style_edit" cols="80" rows="15" style="width:98%">', (!empty($modSettings['tabbed_smilyes_style']) ? $modSettings['tabbed_smilyes_style'] : 'ul#tabs {
	overflow:auto;
	list-style-type: none;
	margin: 30px 0 0 0;
	padding: 1px 0 0 0;
}
ul#tabs li {
	float:left;
	margin:0.3em 0.2em;
}
ul#tabs li a {
	color: #000;
	border: 1px solid #ADADAD;
	border-bottom: none;
	padding: 0.3em;
	text-decoration: none;
}
div.tabContent {
	border: 1px solid #ADADAD;
	width:95%;
}
div.hide {
	display: none;
}') , '</textarea>
				</td>
			</tr>
			<tr class="windowbg2">
				<td colspan="2" align="right">
					<input type="hidden" name="sc" value="', $context['session_id'], '" />
					<input type="submit" value="', $txt['smiley_sets_save'], '" />
				</td>
			</tr>
		</table>
	</form>';

]]></add>
		</operation>
	</file>

</modification>